
@{
    ViewBag.Title = "Management";
}

<div class="container-fluid">
    <div class="row justify-content-center text-center mb-3">
        <div class="col-6 text-primary">
            <h2>用餐桌號</h2>
        </div>
        <div class="col-6 text-primary">
            <h2>訂單管理</h2>
        </div>

    </div>
    <div class="row justify-content-around">
        <div class="col-5">
            <div class="row">
                @foreach (var item in Model)
                {
                    <div class="col-3">
                        <div class="card" data-tableName="@item.SeatName" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight@(item.SeatId)" aria-controls="offcanvasRight@(item.SeatId)" data-seatId="@item.SeatId">
                            <div class="card-body">
                                <h5 class="card-title">@item.SeatName</h5>
                            </div>
                        </div>

                        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight@(item.SeatId)" aria-labelledby="offcanvasRightLabel@(item.SeatId)">
                            <div class="offcanvas-header">
                                <h5 id="offcanvasRightLabel@(item.SeatId)">@item.SeatName 購物車明細</h5>
                                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
                            </div>
                            <div class="offcanvas-body" id="shoppingListContent@(item.SeatId)">
                            </div>
                        </div>
                    </div>


                }
            </div>
        </div>
        <div class="col-6">
            <div class="row justify-content-around">
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle table-bordered border-info">
                        <thead class="table-info">
                            <tr>
                                <th scope="col">組合訂單編號</th>
                                <th scope="col">訂單號碼</th>
                                <th scope="col">桌號</th>
                                <th scope="col">創立時間</th>
                            </tr>
                        </thead>
                        <tbody id="infoTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="row justify-content-around">
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle table-bordered border-info caption-top">
                        <caption class="text-center text-primary h2">清單明細</caption>
                        <thead class="table-info">
                            <tr>
                                <th scope="col">編號</th>
                                <th scope="col">商品名稱</th>
                                <th scope="col">數量</th>
                                <th scope="col">價錢</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="row my-3">
                <div class="col-3">
                    <select class="form-select" id="paymentMethodId">
                        <option selected value="0">付款方式...</option>
                        @foreach (var item in ViewBag.PaymentMethodLists)
                        {
                            <option value="@item.Id">@item.Method</option>
                        }
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-select" id="paymentStatusId">
                        <option selected value="0">付款狀態...</option>
                        @foreach (var item in ViewBag.PaymentStatusLists)
                        {
                            <option value="@item.Id">@item.Status</option>
                        }
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-select" id="memberId">
                        <option selected value="0">會員名稱...</option>
                        @foreach (var item in ViewBag.MemberLists)
                        {
                            <option value="@item.Id">@item.Name</option>
                        }
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-select" id="couponId">
                        <option selected value="0">優惠券名稱...</option>
                        @foreach (var item in ViewBag.CouponLists)
                        {
                            if (item.Id != 1)
                            {
                                <option value="@item.Id" disabled>@item.Condition</option>
                            }
                            else
                            {
                                <option value="@item.Id">@item.Condition</option>
                            }
                        }
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-outline-primary form-control my-3" onclick="sendDataToBackend()">結帳</button>
        </div>
    </div>
</div>

@section CSS{
    <style>
        .card {
            cursor: pointer;
        }

        .selected {
            background-color: lightsalmon;
        }
    </style>
}

@section Scripts{
    <script>
    //日期格式化
    function formatDateTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }


    //送到後台
    async function sendDataToBackend() {
        try {
                const selectedCards = document.querySelectorAll('.card.selected');
                const seatIds = Array.from(selectedCards).map(card => card.dataset.seatid);
                const paymentMethodId = document.querySelector('#paymentMethodId').value;
                const paymentStatusId = document.querySelector('#paymentStatusId').value;
                const memberId = document.querySelector('#memberId').value;
                const couponId = document.querySelector('#couponId').value;

                if (parseInt(paymentMethodId) === 0 || parseInt(paymentStatusId) === 0 || parseInt(memberId) === 0 || parseInt(couponId) === 0) {
                    throw new Error('有選項沒選');
                }


                const response = await fetch('@Url.Content("~/api/SeatCartApiController/Checkout")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ seatIds: seatIds, paymentMethodId: paymentMethodId, paymentStatusId: paymentStatusId, memberId: memberId, couponId: couponId }),
                });

                if (!response.ok) {
                    throw new Error('資料錯誤!!');
                }

                const data = await response.json();

                const result = data.content;

                if (result !== null) {

                    const totalAmount = result.items.reduce(function (acc, item) {
                        return acc + (item.qty * item.price);
                    }, 0);

                    const infoTableBody = document.querySelector('#infoTableBody');
                    infoTableBody.innerHTML = '';

                    let row = infoTableBody.insertRow();
                    row.insertCell(0).textContent = result.combinedOrderId;
                    row.insertCell(1).textContent = result.orderIds.join(", ");
                    row.insertCell(2).textContent = result.seatsName.join(", ");
                    row.insertCell(3).textContent = new Date(result.createTime).toLocaleString();;

                    const detailsTableBody = document.querySelector('#detailsTableBody');
                    detailsTableBody.innerHTML = '';

                    result.items.forEach(function (item,index) {
                        let detailRow = detailsTableBody.insertRow();
                        detailRow.insertCell(0).textContent = index + 1;
                        detailRow.insertCell(1).textContent = item.name;
                        detailRow.insertCell(2).textContent = item.qty;
                        detailRow.insertCell(3).textContent = item.price;
                    });

                    let totalRow = detailsTableBody.insertRow();

                    let cell = totalRow.insertCell(0);
                    cell.setAttribute('colspan', '3');
                    cell.style.textAlign = 'center';
                    cell.textContent = '總金額';

                    let amountCell = totalRow.insertCell(1);
                    amountCell.textContent = totalAmount;

                    const selectedCards = document.querySelectorAll('.card.selected');
                    selectedCards.forEach(card => card.classList.remove('selected'));

                    Swal.fire({
                        icon: 'success',
                        title: '成功',
                        text: '訂單已成立',
                    });
                }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: '錯誤',
                text: error,
            });
        }
    }

    //透過 JavaScript 使用 fetch 加載購物清單數據
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.card');

        cards.forEach((card) => {
            card.addEventListener('click', function () {

                const seatId = card.getAttribute('data-seatId');
                fetchShoppingListData(seatId);
                card.classList.toggle('selected');
            });
        });

        async function fetchShoppingListData(seatId) {
            try {
                const baseUrl = '@Url.Content("~/api/SeatCartApiController/GetSeatCartList")';
                let url = `${baseUrl}/${seatId}`;

                const response = await fetch(url);

                const data = await response.json();

                const shoppingListContent = document.querySelector('#shoppingListContent' + seatId);

                shoppingListContent.innerHTML = '';

                const ul = document.createElement('ul');
                ul.className = 'list-group list-group-flush';

                const result = data.content;
                let totalPrice = 0;

                result.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    const formattedOrderTime = formatDateTime(item.orderTime);

                    const itemTotal = item.qty * item.unitPrice;
                    totalPrice += itemTotal;

                    li.innerHTML = `
                        <p>Id: ${item.id}</p>
                        <p>產品名稱: ${item.productName}</p>
                        <p>數量: ${item.qty}</p>
                        <p>單價: ${item.unitPrice}</p>
                        <p>小計: ${itemTotal}</p>
                        <p>訂單時間: ${formattedOrderTime}</p>
                    `;
                    ul.appendChild(li);
                });

                const totalLi = document.createElement('li');
                totalLi.className = 'list-group-item';
                totalLi.innerHTML = `<strong>總金額: ${totalPrice}</strong>`;
                ul.appendChild(totalLi);

                shoppingListContent.appendChild(ul);


            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: error,
                });
            }
        }
    });
    </script>
}



